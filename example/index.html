<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMTP Bounce Classifier</title>
    <script src="vendor/tailwind.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-2xl mx-auto p-6">
      <h1 class="text-2xl font-bold text-gray-900 mb-1">
        SMTP Bounce Classifier
      </h1>
      <p class="text-gray-500 mb-6">
        Classify SMTP bounce messages using machine learning - runs entirely in
        your browser
      </p>

      <div
        id="status"
        class="hidden mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg"
      ></div>

      <div class="mb-4">
        <label
          for="message"
          class="block text-sm font-medium text-gray-700 mb-2"
          >Enter SMTP bounce message:</label
        >
        <textarea
          id="message"
          class="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-y"
          placeholder="e.g., 550 5.1.1 The email account that you tried to reach does not exist."
        ></textarea>
      </div>

      <button
        id="classify-btn"
        disabled
        class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
      >
        Loading...
      </button>

      <div
        id="result"
        class="hidden mt-6 p-5 bg-white rounded-lg shadow-sm border border-gray-200"
      >
        <h2 class="text-lg font-semibold text-gray-900 mb-4">
          Classification Result
        </h2>
        <div id="result-content"></div>
      </div>

      <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-3">
          Try these examples:
        </h3>
        <div class="flex flex-wrap gap-2">
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="550 5.1.1 The email account that you tried to reach does not exist."
          >
            User Unknown
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="552 5.2.2 The email account that you tried to reach is over quota."
          >
            Mailbox Full
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="421 4.7.0 Try again later, closing connection."
          >
            Greylisting
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="550 5.7.1 Service unavailable, IP blocked by Spamhaus ZEN"
          >
            IP Blacklisted
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="550 5.7.1 Unauthenticated email from example.com is not accepted due to domain's DMARC policy."
          >
            Auth Failure
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="421 4.7.28 Our system has detected an unusual rate of unsolicited mail originating from your IP address. Try again in 30 minutes."
          >
            Rate Limited
          </button>
          <button
            class="example-btn px-3 py-2 text-xs bg-gray-100 text-gray-700 border border-gray-200 rounded hover:bg-gray-200 transition-colors"
            data-message="552 5.7.0 Our system detected an illegal attachment on your message."
          >
            Virus Detected
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        classify,
        initialize,
        extractSmtpCodes,
      } from "../src/index.js";

      const ACTION_STYLES = {
        remove: "bg-red-100 text-red-800",
        retry: "bg-yellow-100 text-yellow-800",
        retry_different_ip: "bg-orange-100 text-orange-800",
        fix_configuration: "bg-purple-100 text-purple-800",
        review: "bg-blue-100 text-blue-800",
        remove_content: "bg-pink-100 text-pink-800",
      };

      // DOM elements
      const statusEl = document.getElementById("status");
      const messageEl = document.getElementById("message");
      const classifyBtn = document.getElementById("classify-btn");
      const resultEl = document.getElementById("result");
      const resultContentEl = document.getElementById("result-content");

      function formatRetryTime(seconds) {
        if (seconds < 60) return `${seconds} second${seconds !== 1 ? "s" : ""}`;
        if (seconds < 3600) {
          const mins = Math.floor(seconds / 60);
          return `${mins} minute${mins !== 1 ? "s" : ""}`;
        }
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        if (mins === 0) return `${hours} hour${hours !== 1 ? "s" : ""}`;
        return `${hours}h ${mins}m`;
      }

      // Display result
      function displayResult(result, message) {
        const confidencePercent = (result.confidence * 100).toFixed(1);
        const sortedScores = Object.entries(result.scores).sort(
          (a, b) => b[1] - a[1],
        );
        const actionStyle =
          ACTION_STYLES[result.action] || "bg-gray-100 text-gray-800";

        // Build badges
        const badges = [];
        const smtpCodes = extractSmtpCodes(message);

        if (smtpCodes.mainCode || smtpCodes.extendedCode) {
          const codes = [];
          if (smtpCodes.mainCode) codes.push(smtpCodes.mainCode);
          if (smtpCodes.extendedCode) codes.push(smtpCodes.extendedCode);
          badges.push(
            `<span class="inline-block px-2 py-1 text-xs rounded bg-sky-100 text-sky-800">SMTP: ${codes.join(" / ")}</span>`,
          );
        }

        if (result.retryAfter) {
          badges.push(
            `<span class="inline-block px-2 py-1 text-xs rounded bg-amber-100 text-amber-800">Retry after: ${formatRetryTime(result.retryAfter)}</span>`,
          );
        }

        if (result.blocklist) {
          const blName = result.blocklist.lists
            ? result.blocklist.lists.map((b) => b.name).join(", ")
            : `${result.blocklist.name} (${result.blocklist.type})`;
          badges.push(
            `<span class="inline-block px-2 py-1 text-xs rounded bg-red-100 text-red-800">Blocklist: ${blName}</span>`,
          );
        }

        resultContentEl.innerHTML = `
                <div class="inline-block px-4 py-2 rounded-full text-sm font-semibold mb-4 ${actionStyle}">
                    ${result.label.replace(/_/g, " ")}
                </div>

                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-500 text-sm">Recommended Action</span>
                    <span class="font-medium text-gray-900 text-sm">${result.action.replace(/_/g, " ")}</span>
                </div>

                ${badges.length > 0 ? `<div class="flex flex-wrap gap-2 mt-4">${badges.join("")}</div>` : ""}

                <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
                    <button onclick="toggleDetails()" class="w-full flex justify-between items-center px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors text-left">
                        <span class="text-sm font-medium text-gray-700">Details</span>
                        <svg id="details-chevron" class="w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="details-content" class="hidden px-4 py-3 border-t border-gray-200">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-500 text-sm">Confidence</span>
                            <div class="flex items-center gap-2">
                                <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full" style="width: ${confidencePercent}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">${confidencePercent}%</span>
                            </div>
                        </div>

                        ${
                          result.usedFallback
                            ? `
                        <div class="flex justify-between py-2">
                            <span class="text-gray-500 text-sm">Note</span>
                            <span class="text-sm text-amber-600">Used SMTP code fallback</span>
                        </div>
                        `
                            : ""
                        }

                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <div class="text-xs font-medium text-gray-500 mb-2">All Scores</div>
                            <div class="grid grid-cols-2 gap-1">
                                ${sortedScores
                                  .map(
                                    ([label, score]) => `
                                    <div class="flex justify-between px-2 py-1 text-xs rounded ${label === result.label ? "bg-green-50 font-medium" : "bg-gray-50"}">
                                        <span class="text-gray-700">${label.replace(/_/g, " ")}</span>
                                        <span class="text-gray-500">${(score * 100).toFixed(1)}%</span>
                                    </div>
                                `,
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                </div>
            `;

        resultEl.classList.remove("hidden");
      }

      // Toggle details accordion
      window.toggleDetails = function () {
        const content = document.getElementById("details-content");
        const chevron = document.getElementById("details-chevron");
        content.classList.toggle("hidden");
        chevron.classList.toggle("rotate-180");
      };

      // Event handlers
      classifyBtn.addEventListener("click", async () => {
        const message = messageEl.value.trim();
        if (!message) {
          alert("Please enter a bounce message");
          return;
        }

        classifyBtn.disabled = true;
        classifyBtn.textContent = "Classifying...";

        try {
          const result = await classify(message);
          displayResult(result, message);
        } catch (error) {
          resultContentEl.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-lg">Error: ${error.message}</div>`;
          resultEl.classList.remove("hidden");
        } finally {
          classifyBtn.disabled = false;
          classifyBtn.textContent = "Classify";
        }
      });

      // Example buttons
      document.querySelectorAll(".example-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          messageEl.value = btn.dataset.message;
        });
      });

      // Ctrl+Enter to submit
      messageEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && e.ctrlKey) {
          classifyBtn.click();
        }
      });

      // Initialize
      try {
        await initialize({ modelPath: "../model" });
        classifyBtn.disabled = false;
        classifyBtn.textContent = "Classify";
      } catch (error) {
        statusEl.textContent = `Error loading model: ${error.message}`;
        statusEl.classList.remove("hidden");
        classifyBtn.textContent = "Error";
        console.error(error);
      }
    </script>
  </body>
</html>
