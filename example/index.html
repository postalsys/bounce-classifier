<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMTP Bounce Classifier</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: system-ui, -apple-system, sans-serif; background: #f9fafb; min-height: 100vh; line-height: 1.5; color: #111827; }
      .container { max-width: 42rem; margin: 0 auto; padding: 1.5rem; }
      h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
      .subtitle { color: #6b7280; margin-bottom: 1.5rem; }
      .status { display: none; margin-bottom: 1rem; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; border-radius: 0.5rem; }
      .status.visible { display: block; }
      .form-group { margin-bottom: 1rem; }
      label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
      textarea { width: 100%; height: 8rem; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: ui-monospace, monospace; font-size: 0.875rem; resize: vertical; outline: none; }
      textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
      .btn { padding: 0.75rem 1.5rem; background: #2563eb; color: white; font-weight: 500; border: none; border-radius: 0.5rem; cursor: pointer; transition: background 0.15s; }
      .btn:hover:not(:disabled) { background: #1d4ed8; }
      .btn:disabled { background: #d1d5db; cursor: not-allowed; }
      .result { display: none; margin-top: 1.5rem; padding: 1.25rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
      .result.visible { display: block; }
      .result h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
      .examples { margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
      .examples h3 { font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.75rem; }
      .examples-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; }
      .example-btn { padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: background 0.15s; }
      .example-btn:hover { background: #e5e7eb; }
      /* Result styles */
      .label-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; }
      .action-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
      .action-row .label { color: #6b7280; }
      .action-row .value { font-weight: 500; }
      .badges { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
      .badge { display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
      .details-panel { margin-top: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
      .details-toggle { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: #f9fafb; border: none; cursor: pointer; text-align: left; font-size: 0.875rem; font-weight: 500; color: #374151; transition: background 0.15s; }
      .details-toggle:hover { background: #f3f4f6; }
      .details-toggle svg { width: 1rem; height: 1rem; color: #6b7280; transition: transform 0.15s; }
      .details-toggle.open svg { transform: rotate(180deg); }
      .details-content { display: none; padding: 0.75rem 1rem; border-top: 1px solid #e5e7eb; }
      .details-content.visible { display: block; }
      .confidence-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 0.875rem; }
      .confidence-row .label { color: #6b7280; }
      .confidence-bar-wrapper { display: flex; align-items: center; gap: 0.5rem; }
      .confidence-bar { width: 6rem; height: 0.5rem; background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
      .confidence-fill { height: 100%; background: #22c55e; border-radius: 9999px; }
      .scores-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6; }
      .scores-title { font-size: 0.75rem; font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; }
      .scores-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem; }
      .score-item { display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; background: #f9fafb; }
      .score-item.highlight { background: #f0fdf4; font-weight: 500; }
      .score-item .name { color: #374151; }
      .score-item .value { color: #6b7280; }
      .error-box { padding: 1rem; background: #fef2f2; color: #b91c1c; border-radius: 0.5rem; }
      /* Badge colors */
      .badge-red { background: #fee2e2; color: #991b1b; }
      .badge-yellow { background: #fef3c7; color: #92400e; }
      .badge-orange { background: #ffedd5; color: #9a3412; }
      .badge-purple { background: #f3e8ff; color: #6b21a8; }
      .badge-blue { background: #dbeafe; color: #1e40af; }
      .badge-pink { background: #fce7f3; color: #9d174d; }
      .badge-gray { background: #f3f4f6; color: #1f2937; }
      .badge-sky { background: #e0f2fe; color: #075985; }
      .badge-amber { background: #fef3c7; color: #92400e; }
      .badge-green { background: #dcfce7; color: #166534; }
      .note-amber { color: #d97706; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>SMTP Bounce Classifier</h1>
      <p class="subtitle">
        Classify SMTP bounce messages using machine learning - runs entirely in
        your browser
      </p>

      <div id="status" class="status"></div>

      <div class="form-group">
        <label for="message">Enter SMTP bounce message:</label>
        <textarea
          id="message"
          placeholder="e.g., 550 5.1.1 The email account that you tried to reach does not exist."
        ></textarea>
      </div>

      <button id="classify-btn" class="btn" disabled>Loading...</button>

      <div id="result" class="result">
        <h2>Classification Result</h2>
        <div id="result-content"></div>
      </div>

      <div class="examples">
        <h3>Try these examples:</h3>
        <div class="examples-grid">
          <button
            class="example-btn"
            data-message="550 5.1.1 The email account that you tried to reach does not exist."
          >
            User Unknown
          </button>
          <button
            class="example-btn"
            data-message="552 5.2.2 The email account that you tried to reach is over quota."
          >
            Mailbox Full
          </button>
          <button
            class="example-btn"
            data-message="421 4.7.0 Try again later, closing connection."
          >
            Greylisting
          </button>
          <button
            class="example-btn"
            data-message="550 5.7.1 Service unavailable, IP blocked by Spamhaus ZEN"
          >
            IP Blacklisted
          </button>
          <button
            class="example-btn"
            data-message="550 5.7.1 Unauthenticated email from example.com is not accepted due to domain's DMARC policy."
          >
            Auth Failure
          </button>
          <button
            class="example-btn"
            data-message="421 4.7.28 Our system has detected an unusual rate of unsolicited mail originating from your IP address. Try again in 30 minutes."
          >
            Rate Limited
          </button>
          <button
            class="example-btn"
            data-message="552 5.7.0 Our system detected an illegal attachment on your message."
          >
            Virus Detected
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        classify,
        initialize,
        extractSmtpCodes,
      } from "../src/index.js";

      const ACTION_STYLES = {
        remove: "badge-red",
        retry: "badge-yellow",
        retry_different_ip: "badge-orange",
        fix_configuration: "badge-purple",
        review: "badge-blue",
        remove_content: "badge-pink",
      };

      // DOM elements
      const statusEl = document.getElementById("status");
      const messageEl = document.getElementById("message");
      const classifyBtn = document.getElementById("classify-btn");
      const resultEl = document.getElementById("result");
      const resultContentEl = document.getElementById("result-content");

      function formatRetryTime(seconds) {
        if (seconds < 60) return `${seconds} second${seconds !== 1 ? "s" : ""}`;
        if (seconds < 3600) {
          const mins = Math.floor(seconds / 60);
          return `${mins} minute${mins !== 1 ? "s" : ""}`;
        }
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        if (mins === 0) return `${hours} hour${hours !== 1 ? "s" : ""}`;
        return `${hours}h ${mins}m`;
      }

      // Display result
      function displayResult(result, message) {
        const confidencePercent = (result.confidence * 100).toFixed(1);
        const sortedScores = Object.entries(result.scores).sort(
          (a, b) => b[1] - a[1],
        );
        const actionStyle = ACTION_STYLES[result.action] || "badge-gray";

        // Build badges
        const badges = [];
        const smtpCodes = extractSmtpCodes(message);

        if (smtpCodes.mainCode || smtpCodes.extendedCode) {
          const codes = [];
          if (smtpCodes.mainCode) codes.push(smtpCodes.mainCode);
          if (smtpCodes.extendedCode) codes.push(smtpCodes.extendedCode);
          badges.push(
            `<span class="badge badge-sky">SMTP: ${codes.join(" / ")}</span>`,
          );
        }

        if (result.retryAfter) {
          badges.push(
            `<span class="badge badge-amber">Retry after: ${formatRetryTime(result.retryAfter)}</span>`,
          );
        }

        if (result.blocklist) {
          const blName = result.blocklist.lists
            ? result.blocklist.lists.map((b) => b.name).join(", ")
            : `${result.blocklist.name} (${result.blocklist.type})`;
          badges.push(
            `<span class="badge badge-red">Blocklist: ${blName}</span>`,
          );
        }

        resultContentEl.innerHTML = `
                <div class="label-badge ${actionStyle}">
                    ${result.label.replace(/_/g, " ")}
                </div>

                <div class="action-row">
                    <span class="label">Recommended Action</span>
                    <span class="value">${result.action.replace(/_/g, " ")}</span>
                </div>

                ${badges.length > 0 ? `<div class="badges">${badges.join("")}</div>` : ""}

                <div class="details-panel">
                    <button onclick="toggleDetails()" class="details-toggle" id="details-toggle">
                        <span>Details</span>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="details-content" class="details-content">
                        <div class="confidence-row">
                            <span class="label">Confidence</span>
                            <div class="confidence-bar-wrapper">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                                </div>
                                <span class="value">${confidencePercent}%</span>
                            </div>
                        </div>

                        ${
                          result.usedFallback
                            ? `
                        <div class="confidence-row">
                            <span class="label">Note</span>
                            <span class="note-amber">Used SMTP code fallback</span>
                        </div>
                        `
                            : ""
                        }

                        <div class="scores-section">
                            <div class="scores-title">All Scores</div>
                            <div class="scores-grid">
                                ${sortedScores
                                  .map(
                                    ([label, score]) => `
                                    <div class="score-item ${label === result.label ? "highlight" : ""}">
                                        <span class="name">${label.replace(/_/g, " ")}</span>
                                        <span class="value">${(score * 100).toFixed(1)}%</span>
                                    </div>
                                `,
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                </div>
            `;

        resultEl.classList.add("visible");
      }

      // Toggle details accordion
      window.toggleDetails = function () {
        const content = document.getElementById("details-content");
        const toggle = document.getElementById("details-toggle");
        content.classList.toggle("visible");
        toggle.classList.toggle("open");
      };

      // Event handlers
      classifyBtn.addEventListener("click", async () => {
        const message = messageEl.value.trim();
        if (!message) {
          alert("Please enter a bounce message");
          return;
        }

        classifyBtn.disabled = true;
        classifyBtn.textContent = "Classifying...";

        try {
          const result = await classify(message);
          displayResult(result, message);
        } catch (error) {
          resultContentEl.innerHTML = `<div class="error-box">Error: ${error.message}</div>`;
          resultEl.classList.add("visible");
        } finally {
          classifyBtn.disabled = false;
          classifyBtn.textContent = "Classify";
        }
      });

      // Example buttons
      document.querySelectorAll(".example-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          messageEl.value = btn.dataset.message;
        });
      });

      // Ctrl+Enter to submit
      messageEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && e.ctrlKey) {
          classifyBtn.click();
        }
      });

      // Initialize
      try {
        await initialize({ modelPath: "../model" });
        classifyBtn.disabled = false;
        classifyBtn.textContent = "Classify";
      } catch (error) {
        statusEl.textContent = `Error loading model: ${error.message}`;
        statusEl.classList.add("visible");
        classifyBtn.textContent = "Error";
        console.error(error);
      }
    </script>
  </body>
</html>
